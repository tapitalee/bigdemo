name: CI/CD

# Functions performed:
# - `test`: runs Go tests for all pull requests and new releases.
# - `build_staging` and `deploy_staging_image`: build and deploy staging image for releases only.
# - `build_prod` builds (not deploy) the production image for releases only.

# On merging a PR to main, `create_release.yml` runs first.
# It then calls ci.yml on that release tag, via inputs.docker_tag

on:
  workflow_call:  # called by create_release.yml
    inputs:
      docker_tag:
        required: true
        type: string
      previous_tag:
        required: false
        type: string
      release_notes:
        required: false
        type: string
  workflow_dispatch:  # For manual/API triggers
    inputs:
      docker_tag:
        required: true
        type: string
      previous_tag:
        required: false
        type: string
      release_notes:
        required: false
        type: string
  pull_request:
    types: [opened, reopened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test -v ./...

  build_staging:
    if: inputs.docker_tag != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build using Tapit
        uses: tapitalee/ghactions/image-build@main
        with:
          tapit-token: ${{ secrets.TAPIT_TOKEN_STAGING }}
          dockerfile: Dockerfile
          docker_tag: ${{ inputs.docker_tag }}

  deploy_staging_image:
    if: inputs.docker_tag != ''
    needs: [test, build_staging]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy using Tapit
        uses: tapitalee/ghactions/create-deploy@main
        with:
          tapit-token: ${{ secrets.TAPIT_TOKEN_STAGING }}
          dockerfile: Dockerfile
          docker_tag: ${{ inputs.docker_tag }}

  build_prod:
    if: inputs.docker_tag != ''
    runs-on: ubuntu-latest
    needs: [deploy_staging_image]
    steps:
      - uses: actions/checkout@v4

      - name: Build using Tapit
        uses: tapitalee/ghactions/image-build@main
        with:
          tapit-token: ${{ secrets.TAPIT_TOKEN_PROD }}
          dockerfile: Dockerfile
          docker_tag: ${{ inputs.docker_tag }}

      - name: Set up Tapit
        uses: tapitalee/ghactions/setup-tapit@main

      - name: Create Tapit Release
        uses: tapitalee/ghactions/create-release@main
        with:
          tapit-token: ${{ secrets.TAPIT_TOKEN_PROD }}
          docker_tag: ${{ inputs.docker_tag }}
          release_notes: ${{ inputs.release_notes }}
          diff_url: ${{ inputs.previous_tag != '' && format('https://github.com/{0}/compare/{1}...{2}', github.repository, inputs.previous_tag, inputs.docker_tag) || '' }}
          release_url: ${{ format('https://github.com/{0}/releases/tag/{1}', github.repository, inputs.docker_tag) }}
